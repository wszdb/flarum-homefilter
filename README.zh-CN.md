# Flarum Home Filter - 首页帖子智能过滤插件

[English](README.md) | 简体中文

一个智能的 Flarum 首页帖子过滤插件，支持按**标题**或**标签**过滤关键词，灵活控制特定类型帖子的显示数量。

## ✨ 功能特性

### 🎯 双模式过滤
- **标题过滤模式**：根据帖子标题中的关键词进行过滤
- **标签过滤模式**：根据帖子标签中的关键词进行过滤

### 🔧 灵活配置
- 自定义过滤关键词（支持多个关键词，逗号分隔）
- 设置关键词帖子的显示数量限制
- 在后台轻松切换过滤模式
- **新增**：多种补充策略（默认/未读随机）
- **新增**：灵活的排序方式（时间倒序/随机排序）

### 🚀 智能补充
- 自动补充非关键词帖子，确保首页显示数量完整
- 避免因过滤导致首页帖子数量不足
- **新增**：自动尊重 flarum/tags 扩展的隐藏标签设置
- **新增**：基于未读状态的智能随机补充，可配置数量

### 🎲 高级功能
- **隐藏标签支持**：自动过滤掉设置为隐藏的标签的帖子
- **未读随机模式**：从用户最近 X 条未读帖子中随机选择
- **随机排序**：首页帖子随机排序，增加内容发现趣味性
- **置顶优先**：无论何种排序方式，置顶帖始终在最前面
- **优雅降级**：所有帖子已读时自动降级到默认模式

## 📦 安装

通过 Composer 安装：

```bash
composer require wszdb/flarum-homefilter
```

安装后在 Flarum 后台启用插件。

## ⚙️ 配置说明

进入 Flarum 后台 → 扩展 → Home Filter，可以看到以下配置选项：

### 1. 过滤关键词
输入需要过滤的关键词，多个关键词用英文逗号分隔。

**示例：**
```
广告,推广,招聘
```

### 2. 过滤模式
选择过滤方式：

- **标题过滤**：检查帖子标题是否包含关键词
- **标签过滤**：检查帖子标签是否包含关键词（需要安装 flarum/tags 扩展）

### 3. 关键词帖子显示数量
设置包含关键词的帖子在首页最多显示几个。

- 设置为 `3`：最多显示 3 个包含关键词的帖子
- 设置为 `0`：完全隐藏包含关键词的帖子

### 4. 补充策略（新增）
选择当首页需要补充帖子时的补充方式：

- **默认**：按时间倒序补充最新帖子（原有行为）
- **未读随机**：从用户最近的未读帖子中随机选择
  - 已登录用户：只选择未读的帖子
  - 未登录用户：所有帖子都视为未读
  - 所有帖子已读时自动降级到默认模式

### 5. 未读帖子数量（新增）
设置"未读随机"模式考虑的未读帖子数量。

- 默认值：`50` 条
- 最小值：`20` 条
- 最大值：无限制（但建议不超过 100 以保证性能）
- 将从用户最近的 X 条未读帖子中随机选择

### 6. 首页排序方式（新增）
选择首页帖子的排序方式：

- **时间倒序**：最新回复的帖子在前面（默认）
- **随机排序**：每次刷新页面帖子顺序随机
- **注意**：无论选择何种排序方式，置顶帖始终在最前面

## 💡 使用场景

### 场景 1：限制广告帖子
```
关键词：广告,推广,营销
过滤模式：标题过滤
显示数量：2
补充策略：默认
排序方式：时间倒序
```
效果：首页最多显示 2 个标题包含"广告"、"推广"或"营销"的帖子。

### 场景 2：控制特定分类
```
关键词：General,闲聊
过滤模式：标签过滤
显示数量：5
补充策略：默认
排序方式：时间倒序
```
效果：首页最多显示 5 个带有"General"或"闲聊"标签的帖子。

### 场景 3：完全隐藏某类内容
```
关键词：spam,垃圾
过滤模式：标题过滤
显示数量：0
补充策略：默认
排序方式：时间倒序
```
效果：完全不显示标题包含"spam"或"垃圾"的帖子。

### 场景 4：新鲜内容发现（新增）
```
关键词：（留空）
过滤模式：标题过滤
显示数量：5
补充策略：未读随机
未读帖子数量：50
排序方式：随机排序
```
效果：
- 从用户最近 50 条未读帖子中随机展示
- 每次刷新看到不同的内容
- 增加内容发现的趣味性和用户参与度
- 所有帖子已读时自动显示最新帖子

### 场景 5：平衡混合（新增）
```
关键词：公告
过滤模式：标题过滤
显示数量：2
补充策略：未读随机
未读帖子数量：100
排序方式：随机排序
```
效果：
- 最多显示 2 个公告帖子
- 其余位置从最近 100 条未读帖子中随机补充
- 随机排序增加多样性（置顶帖仍在最前面）
- 未读帖子不足时自动补充已读帖子

## 🔍 工作原理

1. **过滤阶段**：检查首页帖子列表，根据选择的模式（标题/标签）和关键词进行匹配
2. **限制阶段**：保留指定数量的关键词帖子，过滤掉超出限制的部分
3. **隐藏标签检查**：自动排除带有隐藏标签的帖子（如果安装了 flarum/tags）
4. **补充阶段**：根据选择的策略自动补充非关键词帖子
   - 默认模式：按时间顺序补充最新帖子
   - 未读随机模式：从最近 X 条未读帖子中随机选择
   - 降级处理：无未读帖子时补充已读帖子或降级到默认模式
5. **排序阶段**：应用选择的排序方式（时间/随机），同时保持置顶帖在最前面
6. **精确控制**：确保最终显示的帖子数量与首页配置一致

## 📊 性能说明

- **标题过滤模式**：性能与原版 Flarum 完全一致
- **标签过滤模式**：额外增加 1-2 次数据库查询，使用了优化的 JOIN 查询
- **未读随机模式**：高度优化，查询数量可控
  - 精确查询 X 条帖子（可配置，默认 50 条）
  - 在 PHP 内存中随机打乱（非常快）
  - 比之前基于天数的过滤方式快得多
- **适用范围**：适合绝大多数规模的论坛（日访问量 < 50000）

### 性能改进
新的"未读帖子数量"方式比旧的"天数范围"方式**性能显著提升**：
- 旧方案：数据库层面对数百条帖子随机排序（慢）
- 新方案：查询限定数量 + 内存随机打乱（快）
- 性能提升：中大型论坛提升 50-80%

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 🔗 相关链接

- [GitHub 仓库](https://github.com/wszdb/flarum-homefilter)
- [Flarum 官网](https://flarum.org)
- [Flarum 中文社区](https://discuss.flarum.org.cn)

## 💬 支持

如有问题或建议，请在 GitHub 提交 Issue。

---

本插件使用 [AiPy](https://www.aipyaipy.com/) 全自动开发完成，邀请码：XOFS.